#! /bin/sh

set -eu

if [ -d "/var/www/html/install" ]; then
  php -d memory_limit=-1 /var/www/html/install/index_cli.php \
    --domain="$PS_DOMAIN" \
    --db_server="$DB_SERVER:$DB_PORT" \
    --db_name="$DB_NAME" \
    --db_user="$DB_USER" \
    --db_password="$DB_PASSWD" \
    --prefix="$DB_PREFIX" \
    --firstname="John" \
    --lastname="Doe" \
    --password="$ADMIN_PASSWD" \
    --email="$ADMIN_MAIL" \
    --language=$PS_LANGUAGE \
    --country=$PS_COUNTRY \
    --all_languages=$PS_ALL_LANGUAGES \
    --newsletter=0 \
    --send_email=0 \
    --ssl=$PS_ENABLE_SSL \
    --fixtures

  if [ $? -ne 0 ]; then
    echo 'warning: PrestaShop installation failed.'
    exit 1
  else
    user=$(whoami)

    if [ "$user" = "root" ]; then
      rm -r /var/www/html/install
    else
      sudo rm -r /var/www/html/install
    fi
  fi
fi
